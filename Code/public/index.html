<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HowAreYou â€” Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0d10; --card: #13161a; --muted: #9aa4b2; --text: #e6edf3;
      --good: #31c48d; --ok: #f7b731; --bad: #f65f5f; --accent: #6ea8ff;
      --border: #222832;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    header { max-width: 900px; margin: 0 auto 18px; display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 22px; margin: 0; letter-spacing: 0.2px; }
    main { max-width: 900px; margin: 0 auto; display: grid; gap: 18px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 860px) { main { grid-template-columns: 1fr; } }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px; padding: 16px; box-shadow: 0 2px 16px rgba(0,0,0,0.2);
    }
    .row { display: flex; gap: 10px; align-items: center; }
    input[type=file] {
      padding: 10px; border-radius: 10px; border: 1px dashed var(--border);
      background: #0f1216; color: var(--text); width: 100%;
    }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border);
      background: #1b212a; color: var(--text); cursor: pointer;
    }
    button:hover { background: #232a35; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px;
      border-radius: 999px; font-size: 12px; font-weight: 600;
      background: #0f141a; border: 1px solid var(--border); color: var(--muted);
    }
    .mood { font-weight: 700; }
    .mood.good { color: var(--good); } .mood.ok { color: var(--ok); } .mood.bad { color: var(--bad); }
    .muted { color: var(--muted); font-size: 12px; }
    .grid { display: grid; gap: 10px; }
    .entry { padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: #0f1216; }
    .entry h4 { margin: 0 0 6px; font-size: 14px; }
    .entry p { margin: 6px 0; font-size: 14px; }
    details { margin-top: 8px; }
    .status { min-height: 20px; font-size: 13px; color: var(--muted); }
    .chart { height: 80px; display: flex; align-items: end; gap: 4px; }
    .bar {
      width: 100%; background: linear-gradient(180deg, rgba(110,168,255,.8), rgba(110,168,255,.2));
      border-radius: 4px 4px 0 0; border: 1px solid rgba(110,168,255,.3);
    }
    .section-title { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .link { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <h1>HowAreYou â€” Prototype</h1>
    <a class="pill link" href="/api/entries" target="_blank">View raw JSON</a>
  </header>

  <main>
    <!-- Left: Upload + Latest result -->
    <section class="card">
      <div class="section-title">
        <h2 style="margin:0;font-size:18px">New voice note</h2>
      </div>
      <form id="form" class="grid">
        <input id="audio" type="file" accept="audio/*" required />
        <div class="row">
          <button type="submit">Transcribe & Analyze</button>
          <span id="status" class="status"></span>
        </div>
      </form>

      <div id="result" style="margin-top:12px; display:none;">
        <div class="row" style="justify-content:space-between;">
          <span class="pill">Latest Result</span>
          <span id="resultTime" class="muted"></span>
        </div>
        <div id="resultCard" class="entry" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- Right: History + tiny chart -->
    <section class="card">
      <div class="section-title">
        <h2 style="margin:0;font-size:18px">Recent entries</h2>
        <button id="refresh">Refresh</button>
      </div>
      <div id="chart" class="chart" title="Mood last 10 entries"></div>
      <div id="entries" class="grid" style="margin-top:10px;"></div>
    </section>
  </main>

<script>
const $ = (id) => document.getElementById(id);
const moodClass = (m) => (m >= 7 ? "good" : m >= 4 ? "ok" : "bad");
const moodEmoji = (m) => (m >= 8 ? "ðŸ˜„" : m >= 6 ? "ðŸ™‚" : m >= 4 ? "ðŸ˜" : "ðŸ˜•");
const fmtDate = (iso) => new Date(iso).toLocaleString();

function renderEntry(e) {
  const mood = e.mood ?? null;
  const moodHtml = mood !== null
    ? `<span class="mood ${moodClass(mood)}">${moodEmoji(mood)} ${mood}/10</span>`
    : `<span class="muted">â€“/10</span>`;

  return `
    <div class="entry">
      <div class="row" style="justify-content:space-between;">
        <h4>${fmtDate(e.created_at)}</h4>
        ${moodHtml}
      </div>
      <p><strong>Summary:</strong> ${e.summary ?? "<span class='muted'>(none)</span>"}</p>
      <p><strong>Advice:</strong> ${e.advice ?? "<span class='muted'>(none)</span>"}</p>
    </div>
  `;
}

function renderLatest({ transcript, analysis, created_at }) {
  const mood = analysis?.mood ?? null;
  const moodHtml = mood !== null
    ? `<span class="mood ${moodClass(mood)}">${moodEmoji(mood)} ${mood}/10</span>`
    : `<span class="muted">â€“/10</span>`;

  $("resultCard").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      ${moodHtml}
      <span class="muted">${created_at ? fmtDate(created_at) : ""}</span>
    </div>
    <p><strong>Summary:</strong> ${analysis?.summary ?? "<span class='muted'>(none)</span>"}</p>
    <p><strong>Advice:</strong> ${analysis?.advice ?? "<span class='muted'>(none)</span>"}</p>
    <details>
      <summary>Transcript</summary>
      <pre style="white-space:pre-wrap; margin:6px 0 0;">${transcript}</pre>
    </details>
  `;
  $("result").style.display = "block";
  $("resultTime").textContent = new Date().toLocaleString();
}

function renderChart(rows) {
  const c = $("chart");
  c.innerHTML = "";
  if (!rows?.length) return;
  const last = rows.slice(0, 10).reverse(); // oldest -> newest
  const max = 10;
  last.forEach(r => {
    const h = Math.max(6, Math.round(((r.mood ?? 0) / max) * 80)); // 0â€“80px
    const div = document.createElement("div");
    div.className = "bar";
    div.style.height = h + "px";
    c.appendChild(div);
  });
}

async function loadEntries() {
  const res = await fetch("/api/entries");
  const rows = await res.json();
  $("entries").innerHTML = rows.map(renderEntry).join("");
  renderChart(rows);
}

$("form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = $("audio").files[0];
  if (!file) return;

  $("status").textContent = "Uploading and analyzingâ€¦";
  const fd = new FormData();
  fd.append("audio", file);

  try {
    const res = await fetch("/api/journal", { method: "POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Upload failed");

    $("status").textContent = "Done!";
    renderLatest(data);
    await loadEntries();
  } catch (err) {
    $("status").textContent = "Error: " + err.message;
  }
});

$("refresh").addEventListener("click", loadEntries);
loadEntries();
</script>
</body>
</html>
